"use strict";function stringify(e,i){return stringify.semantics.stringify(e,i)}function makeBlockStringifier(e){return function(i,t,s){var a=e+"{"+s(i.args[1],t)+"}";return"value"===i.args[0].type?a:s(i.args[0],t)+"."+a}}var parse=require("./parse"),precedence=require("./language").precedence,typeToToken=require("./language").operatorTypes,tokenToType=require("./language").operatorTokens;module.exports=stringify,stringify.semantics={makeBlockStringifier:makeBlockStringifier,stringify:function(e,i,t){function s(e){var t=u(e,i);return t?t:"this"}var a,u=this.stringify.bind(this),n=this.stringifiers;if(n[e.type])a=n[e.type](e,i,u);else if(e.inline)a="&"+e.type+"("+e.args.map(s).join(", ")+")";else{var l;1===e.args.length&&"mapBlock"===e.args[0].type?(l=e.type+"{"+u(e.args[0].args[1],i)+"}",e=e.args[0]):l=e.type+"("+e.args.slice(1).map(s).join(", ")+")",a="value"===e.args[0].type?l:u(e.args[0],i)+"."+l}return!t||t.type===e.type&&"if"!==t.type||precedence.get(t.type).has(e.type)?a:"("+a+")"},stringifiers:{value:function(){return""},literal:function(e){return"string"==typeof e.value?"'"+e.value.replace("'","\\'")+"'":""+e.value},parameters:function(){return"$"},record:function(e,i,t){return"{"+Object.map(e.args,function(e,s){var a;return a="value"===e.type?"this":t(e,i),s+": "+a}).join(", ")+"}"},tuple:function(e,i,t){return"["+Object.map(e.args,function(e){return"value"===e.type?"this":t(e)}).join(", ")+"]"},component:function(e,i){var t;return i&&i.components&&e.component?i.components.getObjectLabel?t=i.components.getObjectLabel(e.component):i.components.getLabelForObject&&(t=i.components.getLabelForObject(e.component)):t=e.label,"@"+t},element:function(e){return"#"+e.id},mapBlock:makeBlockStringifier("map"),filterBlock:makeBlockStringifier("filter"),someBlock:makeBlockStringifier("some"),everyBlock:makeBlockStringifier("every"),sortedBlock:makeBlockStringifier("sorted"),sortedSetBlock:makeBlockStringifier("sortedSet"),groupBlock:makeBlockStringifier("group"),groupMapBlock:makeBlockStringifier("groupMap"),minBlock:makeBlockStringifier("min"),maxBlock:makeBlockStringifier("max"),property:function(e,i,t){return"value"===e.args[0].type?"string"==typeof e.args[1].value?e.args[1].value:"literal"===e.args[1].type?"."+e.args[1].value:"this["+t(e.args[1],i)+"]":"parameters"===e.args[0].type?"$"+e.args[1].value:"literal"===e.args[1].type&&/^[\w\d_]+$/.test(e.args[1].value)?t(e.args[0],i,{type:"scope"})+"."+e.args[1].value:t(e.args[0],{type:"scope"},i)+"["+t(e.args[1],i)+"]"},"with":function(e,i,t){var s=t(e.args[1],i,e);return t(e.args[0],i)+"."+s},not:function(e,i,t){return"equals"===e.args[0].type?t(e.args[0].args[0],i,{type:"equals"})+" != "+t(e.args[0].args[1],i,{type:"equals"}):"!"+t(e.args[0],i,e)},neg:function(e,i,t){return"-"+t(e.args[0],i,e)},toNumber:function(e,i,t){return"+"+t(e.args[0],i,e)},parent:function(e,i,t){return"^"+t(e.args[0],i,e)},"if":function(e,i,t){return t(e.args[0],i,e)+" ? "+t(e.args[1],i)+" : "+t(e.args[2],i)},event:function(e,i,t){return e.when+" "+e.event+" -> "+t(e.listener,i)},binding:function(e,i,t,s){var a=s(i.args[0],t)+" "+e+" "+s(i.args[1],t),u="",n=i.descriptor;if(n)for(var l in n)u+=", "+l+": "+s(n[l],t);return a+u},bind:function(e,i,t){return this.binding("<-",e,i,t)},bind2:function(e,i,t){return this.binding("<->",e,i,t)},assign:function(e,i,t){return t(e.args[0],i)+": "+t(e.args[1],i)},block:function(e,i,t){var s="@"+e.label;return e.connection&&("prototype"===e.connection?s+=" < ":"object"===e.connection&&(s+=" : "),s+=t({type:"literal",value:e.module}),e.exports&&"value"!==e.exports.type&&(s+=" "+t(e.exports,i))),s+" {\n"+e.statements.map(function(e){return"    "+t(e,i)+";\n"}).join("")+"}\n"},sheet:function(e,i,t){return"\n"+e.blocks.map(function(e){return t(e,i)}).join("\n")+"\n"}}},typeToToken.forEach(function(e,i){stringify.semantics.stringifiers[i]=function(i,t,s){return i.args.map(function(e){return s(e,t,i)}).join(" "+e+" ").trim()}});