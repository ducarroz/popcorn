var Montage=require("montage/core/core").Montage,Params=require("query-params"),Url=require("url"),Uuid=require("montage/core/uuid"),Promise=require("montage/core/promise").Promise;exports.JsonpTransport=Montage.specialize({constructor:{value:function(){this.super()}},makeRequest:{value:function(e,r,o){var n,t=Promise.defer(),l=this,a=Url.parse(e),c=Params.decode(a.query),i=r?r+"ServiceCallback":"serviceCallback",s=i+Uuid.generate().replace(/-/g,"_"),u=document.createElement("script");return window[s]=function(e){l._handleResponse(e,t),document.head.removeChild(u),delete window[s]},c[o?o:"callback"]=s,n=e.replace(a.query,"")+Params.encode(c),u.src=n,document.head.appendChild(u),t.promise}},_handleResponse:{value:function(e,r){console.log("response",e),e?e.error?r.reject(Error(e.error)):r.resolve(e):r.reject(Error("Unknown API Error"))}}}),exports.shared=new exports.JsonpTransport;